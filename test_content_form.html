<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba del Formulario de Contenido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Prueba del Formulario de Contenido Dinámico</h2>
        
        <div class="mb-3">
            <h4>Simulación del formulario de lección</h4>
            <label class="form-label">Contenido de la lección *</label>
            <input type="hidden" name="content" id="content" value='[{"index":0,"titulo":"Introducción a las señas","descripcion":"Aprende las señas básicas","contenido":"Contenido detallado aquí","media":{"tipo":"video","url":"https://www.youtube.com/watch?v=dQw4w9WgXcQ"}},{"index":1,"titulo":"Alfabeto","descripcion":"Las letras en señas","contenido":"Práctica del alfabeto","media":{"tipo":"image","url":"https://example.com/image.jpg"}}]'>
            
            <!-- Simulación del include content.form -->
            <div id="content-form" class="container">
                <div class="accordion" id="contentAccordion">
                    <!-- El contenido se renderizará aquí dinámicamente -->
                </div>
                <button type="button" id="add-content" class="btn btn-primary mt-3">Añadir Registro</button>
            </div>
        </div>
        
        <div class="mt-4">
            <button type="button" class="btn btn-success" onclick="testLoadContent()">Cargar Contenido de Prueba</button>
            <button type="button" class="btn btn-info" onclick="showCurrentJson()">Mostrar JSON Actual</button>
            <button type="button" class="btn btn-warning" onclick="clearContent()">Limpiar Contenido</button>
        </div>
        
        <div class="mt-4">
            <h5>JSON Actual:</h5>
            <textarea id="jsonDisplay" class="form-control" rows="10" readonly></textarea>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Simulación del toastify component -->
    <script>
        window.showToast = function(message, type) {
            console.log(`Toast [${type}]: ${message}`);
            alert(`${type.toUpperCase()}: ${message}`);
        };
    </script>
    
    <!-- Script del formulario de contenido -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const contentAccordion = document.getElementById('contentAccordion');
            const addContentButton = document.getElementById('add-content');

            // Definir funciones primero antes de usarlas
            
            // Función para convertir el array del formulario a JSON
            function contentArrayToJson() {
                const contentArray = [];
                const contentItems = contentAccordion.querySelectorAll('.content-item');
                
                contentItems.forEach((item, index) => {
                    const titulo = item.querySelector(`[name="content[${index}][titulo]"]`)?.value || '';
                    const descripcion = item.querySelector(`[name="content[${index}][descripcion]"]`)?.value || '';
                    const contenido = item.querySelector(`[name="content[${index}][contenido]"]`)?.value || '';
                    const mediaTipo = item.querySelector(`[name="content[${index}][media][tipo]"]`)?.value || 'image';
                    const mediaUrl = item.querySelector(`[name="content[${index}][media][url]"]`)?.value || '';
                    
                    contentArray.push({
                        index: index,
                        titulo: titulo.trim(),
                        descripcion: descripcion.trim(),
                        contenido: contenido.trim(),
                        media: {
                            tipo: mediaTipo,
                            url: mediaUrl.trim()
                        }
                    });
                });
                
                return JSON.stringify(contentArray);
            }

            // Función para convertir JSON a array y cargar en el formulario
            function jsonToContentArray(jsonString) {
                try {
                    const contentArray = JSON.parse(jsonString);
                    
                    // Limpiar acordeón actual
                    contentAccordion.innerHTML = '';
                    
                    // Crear elementos del acordeón basados en el array
                    contentArray.forEach((item) => {
                        const index = item.index !== undefined ? item.index : contentArray.indexOf(item);
                        const newItem = document.createElement('div');
                        newItem.classList.add('accordion-item', 'content-item');
                        newItem.setAttribute('data-index', index);
                        newItem.innerHTML = `
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                        aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse${index}">
                                    ${item.titulo || 'Contenido ' + (index + 1)}
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                 aria-labelledby="heading${index}" data-bs-parent="#contentAccordion">
                                <div class="accordion-body">
                                    <div class="mb-2">
                                        <label for="content[${index}][titulo]" class="form-label">Título:</label>
                                        <input type="text" class="form-control titulo-input" name="content[${index}][titulo]" 
                                               value="${item.titulo || ''}">
                                    </div>
                                    <div class="mb-2">
                                        <label for="content[${index}][descripcion]" class="form-label">Descripción:</label>
                                        <textarea class="form-control" name="content[${index}][descripcion]">${item.descripcion || ''}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label for="content[${index}][contenido]" class="form-label">Contenido:</label>
                                        <textarea class="form-control" name="content[${index}][contenido]">${item.contenido || ''}</textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label for="content[${index}][media][tipo]" class="form-label">Media Tipo:</label>
                                        <select class="form-select" name="content[${index}][media][tipo]">
                                            <option value="image" ${(item.media?.tipo === 'image') ? 'selected' : ''}>Imagen</option>
                                            <option value="video" ${(item.media?.tipo === 'video') ? 'selected' : ''}>Video</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label for="content[${index}][media][url]" class="form-label">Media URL:</label>
                                        <input type="text" class="form-control" name="content[${index}][media][url]" 
                                               value="${item.media?.url || ''}">
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <button type="button" class="btn btn-success btn-sm save-content">Guardar</button>
                                        <button type="button" class="btn btn-danger btn-sm remove-content">Eliminar</button>
                                        <div>
                                            <button type="button" class="btn btn-secondary btn-sm move-up">Subir</button>
                                            <button type="button" class="btn btn-secondary btn-sm move-down">Bajar</button>
                                        </div>
                                    </div>
                                    <div class="preview" style="display: none;">
                                        <h5>Previsualización:</h5>
                                        <div class="preview-content"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        contentAccordion.appendChild(newItem);
                        attachEventListeners(newItem);
                    });
                    
                    if (window.showToast) {
                        window.showToast('Contenido cargado desde JSON correctamente', 'success');
                    }
                    return contentArray;
                    
                } catch (error) {
                    console.error('Error al procesar el JSON:', error);
                    if (window.showToast) {
                        window.showToast('Error al procesar el JSON: ' + error.message, 'error');
                    }
                    return null;
                }
            }

            // Función para actualizar el campo hidden con el JSON actual
            function updateHiddenJson() {
                const hiddenField = document.getElementById('content');
                if (hiddenField) {
                    const jsonData = contentArrayToJson();
                    hiddenField.value = jsonData || '[]';
                    console.log('JSON actualizado:', hiddenField.value);
                    
                    // Actualizar el textarea de visualización
                    const jsonDisplay = document.getElementById('jsonDisplay');
                    if (jsonDisplay) {
                        jsonDisplay.value = JSON.stringify(JSON.parse(hiddenField.value), null, 2);
                    }
                }
            }

            // Hacer funciones globales para uso externo
            window.contentArrayToJson = contentArrayToJson;
            window.jsonToContentArray = jsonToContentArray;
            window.updateHiddenJson = updateHiddenJson;

            // Resto de funciones...
            function attachEventListeners(item) {
                // ... (resto del código de attachEventListeners)
            }

            // Cargar contenido inicial
            const contentField = document.getElementById('content');
            console.log('Campo content encontrado:', !!contentField);
            if (contentField) {
                console.log('Contenido inicial del campo hidden:', contentField.value);
                
                const hiddenContent = contentField.value;
                if (hiddenContent && hiddenContent.trim() !== '' && hiddenContent.trim() !== '[]') {
                    try {
                        console.log('Intentando cargar contenido inicial...');
                        jsonToContentArray(hiddenContent);
                        console.log('Contenido inicial cargado correctamente.');
                    } catch (error) {
                        console.error('Error al procesar el contenido inicial:', error);
                    }
                } else {
                    console.log('No se encontró contenido inicial para cargar o está vacío.');
                }
            }

            updateHiddenJson();
        });

        // Funciones de prueba
        window.testLoadContent = function() {
            const testJson = JSON.stringify([
                {
                    index: 0,
                    titulo: "Lección de prueba 1",
                    descripcion: "Esta es una descripción de prueba",
                    contenido: "Contenido detallado aquí",
                    media: {
                        tipo: "video",
                        url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
                    }
                },
                {
                    index: 1,
                    titulo: "Lección de prueba 2",
                    descripcion: "Segunda lección",
                    contenido: "Más contenido",
                    media: {
                        tipo: "image",
                        url: "https://via.placeholder.com/300x200"
                    }
                }
            ]);
            
            document.getElementById('content').value = testJson;
            if (window.jsonToContentArray) {
                window.jsonToContentArray(testJson);
            }
        };

        window.showCurrentJson = function() {
            if (window.updateHiddenJson) {
                window.updateHiddenJson();
            }
        };

        window.clearContent = function() {
            document.getElementById('content').value = '[]';
            document.getElementById('contentAccordion').innerHTML = '';
            if (window.updateHiddenJson) {
                window.updateHiddenJson();
            }
        };
    </script>
</body>
</html>